<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïê RedM Rel√≥gio ‚Äì 20s real = 10 min jogo + Alarmes Lend√°rios</title>
    <style>
        body {
            background: linear-gradient(135deg, #0a001f, #2a0044);
            color: #e0f0ff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        h1, h2 { color: #aaffff; text-shadow: 0 0 15px #00ffff; margin: 10px 0; }
        .info { color: #aaa; font-size: 1.1em; margin: 10px 0 25px; }
        .section {
            background: rgba(0,0,0,0.5);
            border-radius: 16px;
            padding: 25px;
            margin: 20px auto;
            max-width: 960px;
            border: 1px solid #5555aa;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .time-big { 
            font-size: 5.2em; 
            color: #00ffff; 
            font-weight: bold; 
            letter-spacing: 6px; 
            text-shadow: 0 0 25px #00ffff; 
            margin: 15px 0; 
        }
        input[type="text"], input[type="time"] { 
            font-size: 1.6em; 
            padding: 10px 14px; 
            width: 140px; 
            text-align: center; 
            background: #1e1e3a; 
            border: 2px solid #6666ff; 
            border-radius: 10px; 
            color: #00ffff; 
        }
        button {
            font-size: 1.3em;
            padding: 12px 24px;
            margin: 8px 4px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.25s;
        }
        button.primary { background: #00aaff; color: white; }
        button.primary:hover { background: #0088cc; transform: scale(1.05); }
        button.add { background: #33cc66; color: white; }
        button.reset { background: #ff6666; color: white; }
        .bar { width: 100%; height: 28px; background: #222; border-radius: 14px; overflow: hidden; margin: 20px 0; box-shadow: inset 0 0 12px #000; }
        .bar-fill { height: 100%; background: linear-gradient(90deg, #ff3366, #ffff00, #33ff99); transition: width 0.7s; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 1.1em;
        }
        th, td { padding: 12px; border: 1px solid #444; }
        th { background: #2a2a55; }
        .delete-btn { background: #cc0000; color: white; padding: 6px 12px; font-size: 1em; }
        #status, #discordStatus { 
            font-size: 1.3em; 
            margin: 20px; 
            padding: 15px; 
            border-radius: 12px; 
            background: rgba(0,0,0,0.6); 
            min-height: 30px; 
        }
        .success { background: rgba(0,255,100,0.25); color: #88ffaa; }
        .error   { background: rgba(255,80,80,0.25); color: #ff8888; }
        #countdown { font-size: 2.6em; color: #ffdd44; font-weight: bold; margin: 20px 0; }
        #calcResult { display: none; font-size: 1.5em; margin-top: 25px; padding: 15px; background: rgba(0,200,0,0.15); border-radius: 12px; }
        .flash { animation: flash 1.2s infinite; }
        @keyframes flash { 0%,100% { background: rgba(255,80,80,0.3); } 50% { background: rgba(255,0,0,0.6); } }

        .tabs-header { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; border-bottom: 2px solid #444; padding-bottom: 10px; }
        .tab-btn {
            padding: 10px 18px;
            border: 1px solid #6666ff;
            background: #1e1e3a;
            color: #aaffff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
        }
        .tab-btn:hover { background: #2a2a55; }
        .tab-btn.active { background: #00aaff; color: white; border-color: #00aaff; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .hunt-table input[type="text"] { font-size: 0.95em; width: 100%; min-width: 70px; padding: 6px 8px; }
        .hunt-table input[type="time"] { font-size: 0.95em; padding: 6px; }
    </style>
</head>
<body>
    <h1>üïê RedM Rel√≥gio + Alarmes Lend√°rios</h1>
    <div class="info">20s real = 10 min jogo ‚Ä¢ 24h jogo = 48 min reais ‚Ä¢ Sincronizado com UTC (00:00 UTC = 00:00 no jogo)</div>

    <div class="section">
        <div>Hora atual no jogo:</div>
        <div class="time-big" id="gameTime">00:00</div>
        <div>Progresso do dia: <span id="prog">0.0</span>%</div>
        <div class="bar"><div id="barFill" class="bar-fill" style="width:0%"></div></div>

        <input type="text" id="editTime" value="01:42" placeholder="HH:MM">
        <button class="primary" id="applyEdit">Aplicar / Corrigir</button>
    </div>

    <div class="section">
        <h2>Calculadora ‚Äì Quando ser√° na vida real?</h2>
        <input type="text" id="targetTime" placeholder="Ex: 05:30">
        <button class="primary" id="calc">Calcular</button>

        <div id="calcResult">
            <div>Hora real aproximada: <span id="projReal">--:--:--</span></div>
            <div>Faltam: <span id="delta">-- min</span></div>
            <div id="countdown">00:00</div>
        </div>
    </div>

    <div class="section">
        <h2>ü¶å Alarmes ‚Äì Ca√ßas por Tipo</h2>

        <div class="tabs-header">
            <button class="tab-btn active" data-tab="0">Animais Lend√°rios</button>
            <button class="tab-btn" id="addTabBtn">+ Nova aba</button>
        </div>

        <div id="tabPanels">
            <div class="tab-panel active" data-tab="0">
                <div style="margin: 15px 0;">
                    <input type="text" id="newAnimalName" placeholder="Nome" style="width: 140px;">
                    <input type="text" id="newAnimalIsco" placeholder="Isco" style="width: 100px;">
                    <input type="text" id="newAnimalXp" placeholder="XP" style="width: 60px;">
                    <input type="text" id="newAnimalLocal" placeholder="Local" style="width: 140px;">
                    <input type="time" id="newAnimalHoraInicio" placeholder="Hora in√≠cio" value="12:00">
                    <input type="time" id="newAnimalHoraFim" placeholder="Hora fim" value="13:00">
                    <button class="add" id="addAlarm">+ Adicionar</button>
                    <button class="reset" id="resetHunted">Resetar Ca√ßados</button>
                </div>
                <table id="alarmsTable" class="hunt-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Isco</th>
                            <th>XP</th>
                            <th>Local</th>
                            <th>Hora in√≠cio</th>
                            <th>Hora fim</th>
                            <th>Ca√ßado?</th>
                            <th>A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Discord Webhook (opcional)</h2>
        <input type="text" id="webhookUrl" placeholder="https://discord.com/api/webhooks/..." style="width:90%; max-width:620px; font-size:1.1em; margin-bottom:10px;">
        <br>
        <button class="discord" id="sendTest">Testar Envio</button>
        <button class="discord" id="toggleAuto">Iniciar Auto-Update (60s)</button>
        <div id="discordStatus" style="margin-top:15px; font-size:1.2em; min-height:28px;"></div>
    </div>

    <div id="status" class="success">Rel√≥gio iniciado ‚Ä¢ Nova escala: 20s real = 10 min jogo</div>

    <script>
        // CONFIGURA√á√ÉO DO TEMPO ‚Äì sincronizado com UTC (rel√≥gio mundial 00)
        const CYCLE_MIN = 1440;                     // 24 horas = 1440 minutos
        const GAME_MIN_PER_REAL_SEC = 0.5;          // 20s real = 10 min jogo ‚Üí 1s real = 0.5 min jogo
        const OFFSET_STORAGE_KEY = 'redmRelogioOffset';

        let offsetMinutes = 0;                      // corre√ß√£o manual (0 = 00:00 UTC = 00:00 jogo)

        let autoUpdateId = null;
        let countdownId = null;
        let huntTypes = [];
        let currentTabIndex = 0;

        function pad(n) { return String(Math.floor(n)).padStart(2, '0'); }

        function timeToMinutes(str) {
            if (!str) return -1;
            const [h, m] = str.split(':').map(Number);
            if (isNaN(h) || isNaN(m)) return -1;
            return h * 60 + m;
        }

        // Hora no jogo a partir de UTC: 00:00 UTC = 00:00 no jogo (escala 20s real = 10 min jogo)
        function getUtcSecondsSinceMidnight() {
            const d = new Date();
            return d.getUTCHours() * 3600 + d.getUTCMinutes() * 60 + d.getUTCSeconds() + d.getUTCMilliseconds() / 1000;
        }

        function getCurrentGameMin() {
            const utcSec = getUtcSecondsSinceMidnight();
            const utcGameMin = (utcSec * GAME_MIN_PER_REAL_SEC) % CYCLE_MIN;
            return (utcGameMin + offsetMinutes + CYCLE_MIN) % CYCLE_MIN;
        }

        function loadClockOffset() {
            try {
                const saved = localStorage.getItem(OFFSET_STORAGE_KEY);
                if (saved !== null) offsetMinutes = parseInt(saved, 10) || 0;
            } catch (e) {}
        }

        function saveClockOffset() {
            try { localStorage.setItem(OFFSET_STORAGE_KEY, String(offsetMinutes)); } catch (e) {}
        }

        function updateClock() {
            const gameMinTotal = getCurrentGameMin();
            const h = Math.floor(gameMinTotal / 60);
            const m = Math.floor(gameMinTotal % 60);
            document.getElementById('gameTime').textContent = `${pad(h)}:${pad(m)}`;

            const progress = ((gameMinTotal / CYCLE_MIN) * 100).toFixed(1);
            document.getElementById('prog').textContent = progress;
            document.getElementById('barFill').style.width = `${progress}%`;

            checkAllAlarms(gameMinTotal);

            if (autoUpdateId) sendDiscordUpdate(`${pad(h)}:${pad(m)} | ${progress}%`);
        }

        function applyEdit() {
            const val = document.getElementById('editTime').value.trim();
            const match = val.match(/^(\d{1,2}):(\d{2})$/);
            if (!match) return showStatus('Formato inv√°lido. Use HH:MM', 'error');

            const hh = parseInt(match[1]);
            const mm = parseInt(match[2]);
            if (hh > 23 || mm > 59) return showStatus('Hora inv√°lida (00:00‚Äì23:59)', 'error');

            const wantedGameMin = hh * 60 + mm;
            const utcSec = getUtcSecondsSinceMidnight();
            const utcGameMin = (utcSec * GAME_MIN_PER_REAL_SEC) % CYCLE_MIN;
            offsetMinutes = (wantedGameMin - utcGameMin + CYCLE_MIN) % CYCLE_MIN;
            if (offsetMinutes > CYCLE_MIN / 2) offsetMinutes -= CYCLE_MIN;

            saveClockOffset();
            showStatus(`Hora ajustada para ${val} (corre√ß√£o guardada)`, 'success');
            updateClock();
        }

        function calculateFuture() {
            const val = document.getElementById('targetTime').value.trim();
            const match = val.match(/^(\d{1,2}):(\d{2})$/);
            if (!match) return showStatus('Alvo inv√°lido. Use HH:MM', 'error');

            const th = parseInt(match[1]);
            const tm = parseInt(match[2]);
            const targetMin = (th * 60 + tm + CYCLE_MIN) % CYCLE_MIN;

            const curGameMin = getCurrentGameMin();
            const now = Date.now() / 1000;

            let deltaGameMin = (targetMin - curGameMin + CYCLE_MIN) % CYCLE_MIN;
            const deltaRealSec = deltaGameMin / GAME_MIN_PER_REAL_SEC;

            const projTime = new Date(now * 1000 + deltaRealSec * 1000);
            document.getElementById('projReal').textContent = projTime.toLocaleTimeString('pt-BR', {hour12:false});
            document.getElementById('delta').textContent = `${Math.floor(deltaGameMin)} min (${Math.round(deltaRealSec)}s)`;

            document.getElementById('calcResult').style.display = 'block';

            if (countdownId) clearInterval(countdownId);
            const cdStart = now;
            countdownId = setInterval(() => {
                const rem = Math.max(0, deltaRealSec - (Date.now()/1000 - cdStart));
                const rm = Math.floor(rem / 60);
                const rs = Math.floor(rem % 60);
                document.getElementById('countdown').textContent = rem > 0 ? `${pad(rm)}:${pad(rs)}` : 'üö® AGORA!';
                if (rem <= 0) clearInterval(countdownId);
            }, 980);
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // ALARMES ‚Äì ABAS POR TIPO DE CA√áA
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function loadAnimals() {
            try {
                const saved = localStorage.getItem('redmLendarios');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (Array.isArray(data)) {
                        huntTypes = [{ name: 'Animais Lend√°rios', animals: data.map(a => ({
                            name: a.name || '',
                            isco: a.isco || '',
                            xp: a.xp || '',
                            local: a.local || '',
                            time: a.time || '12:00',
                            timeEnd: a.timeEnd || a.time || '13:00',
                            hunted: !!a.hunted
                        })) }];
                    } else if (data.huntTypes) {
                        huntTypes = data.huntTypes;
                    } else {
                        huntTypes = [{ name: 'Animais Lend√°rios', animals: [] }];
                    }
                }
            } catch (e) {}
            if (!huntTypes.length) {
                huntTypes = [{
                    name: 'Animais Lend√°rios',
                    animals: [
                        { name: 'Urso Bharati', isco: '', xp: '', local: '', time: '02:15', timeEnd: '03:15', hunted: false },
                        { name: 'Lobo Lend√°rio', isco: '', xp: '', local: '', time: '04:45', timeEnd: '05:45', hunted: false },
                        { name: 'Alce Lend√°rio', isco: '', xp: '', local: '', time: '07:30', timeEnd: '08:30', hunted: false },
                        { name: 'Pantera Lend√°ria', isco: '', xp: '', local: '', time: '23:10', timeEnd: '00:10', hunted: false }
                    ]
                }];
            }
            renderTabs();
            renderAlarmsTable();
        }

        function saveAnimals() {
            try {
                localStorage.setItem('redmLendarios', JSON.stringify({ huntTypes }));
            } catch (e) {}
        }

        function getCurrentAnimals() {
            return huntTypes[currentTabIndex] ? huntTypes[currentTabIndex].animals : [];
        }

        function renderTabs() {
            const header = document.querySelector('.tabs-header');
            const first = header.querySelector('.tab-btn[data-tab="0"]');
            header.innerHTML = '';
            huntTypes.forEach((ht, i) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn' + (i === currentTabIndex ? ' active' : '');
                btn.dataset.tab = String(i);
                btn.textContent = ht.name;
                if (i === 0) btn.dataset.tab = '0';
                btn.onclick = () => { currentTabIndex = i; document.querySelectorAll('.tab-btn').forEach((b,j)=>{ b.classList.toggle('active', j===i); }); renderAlarmsTable(); };
                header.appendChild(btn);
            });
            const addBtn = document.createElement('button');
            addBtn.className = 'tab-btn';
            addBtn.id = 'addTabBtn';
            addBtn.textContent = '+ Nova aba';
            addBtn.onclick = addNewTab;
            header.appendChild(addBtn);
        }

        function addNewTab() {
            const name = prompt('Nome do tipo de ca√ßa (ex: Peixes, Aves):', 'Nova categoria');
            if (!name || !name.trim()) return;
            huntTypes.push({ name: name.trim(), animals: [] });
            currentTabIndex = huntTypes.length - 1;
            saveAnimals();
            renderTabs();
            renderAlarmsTable();
            showStatus('Aba adicionada: ' + name.trim(), 'success');
        }

        function renderAlarmsTable() {
            const tbody = document.querySelector('#alarmsTable tbody');
            tbody.innerHTML = '';
            const animals = getCurrentAnimals();
            animals.forEach((animal, index) => {
                const row = document.createElement('tr');
                const esc = (v) => (v == null ? '' : String(v)).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;');
                row.innerHTML = `
                    <td><input type="text" value="${esc(animal.name)}" onchange="getCurrentAnimals()[${index}].name=this.value;saveAnimals();"></td>
                    <td><input type="text" value="${esc(animal.isco)}" onchange="getCurrentAnimals()[${index}].isco=this.value;saveAnimals();"></td>
                    <td><input type="text" value="${esc(animal.xp)}" onchange="getCurrentAnimals()[${index}].xp=this.value;saveAnimals();"></td>
                    <td><input type="text" value="${esc(animal.local)}" onchange="getCurrentAnimals()[${index}].local=this.value;saveAnimals();"></td>
                    <td><input type="time" value="${esc(animal.time)}" onchange="getCurrentAnimals()[${index}].time=this.value;saveAnimals();"></td>
                    <td><input type="time" value="${esc(animal.timeEnd)}" onchange="getCurrentAnimals()[${index}].timeEnd=this.value;saveAnimals();"></td>
                    <td><input type="checkbox" ${animal.hunted ? 'checked' : ''} onchange="getCurrentAnimals()[${index}].hunted=this.checked;saveAnimals();"></td>
                    <td><button class="delete-btn" onclick="getCurrentAnimals().splice(${index},1);saveAnimals();renderAlarmsTable();">X</button></td>
                `;
                tbody.appendChild(row);
            });
        }

        function addAlarm() {
            const name = document.getElementById('newAnimalName').value.trim();
            const horaInicio = document.getElementById('newAnimalHoraInicio').value;
            if (!name || !horaInicio) return showStatus('Preenche nome e hora in√≠cio!', 'error');

            const isco = document.getElementById('newAnimalIsco').value.trim();
            const xp = document.getElementById('newAnimalXp').value.trim();
            const local = document.getElementById('newAnimalLocal').value.trim();
            const horaFim = document.getElementById('newAnimalHoraFim').value || horaInicio;

            getCurrentAnimals().push({
                name, isco, xp, local,
                time: horaInicio,
                timeEnd: horaFim,
                hunted: false
            });
            saveAnimals();
            renderAlarmsTable();
            document.getElementById('newAnimalName').value = '';
            document.getElementById('newAnimalIsco').value = '';
            document.getElementById('newAnimalXp').value = '';
            document.getElementById('newAnimalLocal').value = '';
            showStatus(`Adicionado: ${name} (${horaInicio}‚Äì${horaFim})`, 'success');
        }

        function checkAllAlarms(currentGameMin) {
            const floorMin = Math.floor(currentGameMin);
            huntTypes.forEach(ht => {
                ht.animals.forEach(animal => {
                    if (animal.hunted) return;
                    const alarmMin = timeToMinutes(animal.time);
                    if (alarmMin >= 0 && floorMin === alarmMin) triggerAlarm(animal);
                });
            });
        }

        function triggerAlarm(animal) {
            playBeep();
            document.body.classList.add('flash');
            setTimeout(() => document.body.classList.remove('flash'), 4000);

            const timeRange = animal.timeEnd ? `${animal.time} ‚Äì ${animal.timeEnd}` : animal.time;
            if (Notification.permission === 'granted') {
                new Notification(`ü¶å ${animal.name} dispon√≠vel!`, {
                    body: `Hora no jogo: ${timeRange}`,
                    icon: 'https://via.placeholder.com/192?text=ü¶å'
                });
            }
            showStatus(`ALERTA: ${animal.name} spawnou! (${timeRange})`, 'success');
        }

        function playBeep() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, ctx.currentTime);
            osc.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.18);
            setTimeout(() => {
                const osc2 = ctx.createOscillator();
                osc2.frequency.setValueAtTime(1100, ctx.currentTime);
                osc2.connect(ctx.destination);
                osc2.start();
                osc2.stop(ctx.currentTime + 0.18);
            }, 220);
        }

        async function sendDiscordUpdate(text) {
            const url = document.getElementById('webhookUrl').value.trim();
            if (!url) return;
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        embeds: [{
                            title: "üïê Hora Atual no RedM",
                            description: text,
                            color: 0x00ffff,
                            timestamp: new Date().toISOString(),
                            footer: { text: "20s real = 10 min jogo ‚Ä¢ Alarmes ativos" }
                        }]
                    })
                });
                if (res.ok) {
                    document.getElementById('discordStatus').textContent = 'Enviado ‚úì';
                    document.getElementById('discordStatus').style.color = '#88ffaa';
                }
            } catch (err) {
                document.getElementById('discordStatus').textContent = 'Erro: ' + err.message;
                document.getElementById('discordStatus').style.color = '#ff8888';
            }
        }

        function showStatus(msg, type) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = type;
        }

        // Eventos
        document.getElementById('applyEdit').onclick = applyEdit;
        document.getElementById('editTime').onkeypress = e => { if (e.key === 'Enter') applyEdit(); };

        document.getElementById('calc').onclick = calculateFuture;
        document.getElementById('targetTime').onkeypress = e => { if (e.key === 'Enter') calculateFuture(); };

        document.getElementById('addAlarm').onclick = addAlarm;
        document.getElementById('resetHunted').onclick = () => {
            huntTypes.forEach(ht => ht.animals.forEach(a => a.hunted = false));
            saveAnimals();
            renderAlarmsTable();
            showStatus('Todos os ca√ßados resetados', 'success');
        };

        document.getElementById('sendTest').onclick = () => {
            const t = document.getElementById('gameTime').textContent;
            const p = document.getElementById('prog').textContent;
            sendDiscordUpdate(`Teste: ${t} | Progresso: ${p}%`);
        };

        document.getElementById('toggleAuto').onclick = function() {
            if (autoUpdateId) {
                clearInterval(autoUpdateId);
                autoUpdateId = null;
                this.textContent = 'Iniciar Auto-Update (60s)';
                showStatus('Auto-update parado', 'error');
            } else {
                autoUpdateId = setInterval(updateClock, 60000);
                this.textContent = 'Parar Auto-Update';
                showStatus('Auto-update iniciado ‚Äì envia para Discord a cada 60s', 'success');
            }
            updateClock();
        };

        // In√≠cio ‚Äì rel√≥gio sincronizado com UTC (00:00 UTC = 00:00 no jogo)
        loadClockOffset();
        loadAnimals();
        Notification.requestPermission();
        setInterval(updateClock, 1000);
        updateClock();
        document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') updateClock(); });
    </script>
</body>
</html>